-- Migration: create iwf and usaw meet results tables (idempotent)
-- This file is intended for use in Supabase SQL editor; run as a single script.

-- IWF meet results
CREATE TABLE IF NOT EXISTS public.iwf_meet_results (
  db_result_id bigint generated by default as identity not null,
  db_lifter_id bigint not null,
  meet_name text null,
  date text null,
  age_category text null,
  weight_class text null,
  lifter_name text null,
  body_weight_kg text null,
  snatch_lift_1 text null,
  snatch_lift_2 text null,
  snatch_lift_3 text null,
  best_snatch text null,
  cj_lift_1 text null,
  cj_lift_2 text null,
  cj_lift_3 text null,
  best_cj text null,
  total text null,
  snatch_successful_attempts integer null,
  cj_successful_attempts integer null,
  total_successful_attempts integer null,
  best_snatch_ytd numeric null,
  best_cj_ytd numeric null,
  best_total_ytd numeric null,
  bounce_back_snatch_2 boolean null,
  bounce_back_snatch_3 boolean null,
  bounce_back_cj_2 boolean null,
  bounce_back_cj_3 boolean null,
  gender text null,
  birth_year integer null,
  competition_age integer null,
  competition_group character varying(10) null,
  rank integer null,
  qpoints numeric(10, 3) null,
  q_masters numeric(10, 3) null,
  q_youth numeric(10, 3) null,
  created_at timestamp without time zone null default now(),
  updated_at timestamp without time zone null default now(),
  manual_override boolean null default false,
  country_code character varying(3) null,
  country_name text null,
  db_meet_id bigint null,
  CONSTRAINT iwf_meet_results_pkey PRIMARY KEY (db_result_id)
)
TABLESPACE pg_default;

CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_country_code ON public.iwf_meet_results USING btree (country_code) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_country_name ON public.iwf_meet_results USING btree (country_name) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_date ON public.iwf_meet_results USING btree (date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_db_lifter_date ON public.iwf_meet_results USING btree (db_lifter_id, date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_db_lifter_id ON public.iwf_meet_results USING btree (db_lifter_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_iwf_meet_results_weight_class ON public.iwf_meet_results USING btree (weight_class) TABLESPACE pg_default;

-- IWF triggers (drop if exists for idempotency)
DROP TRIGGER IF EXISTS iwf_meet_results_ytd_calculation_trigger ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_ytd_calculation_trigger
  BEFORE INSERT OR UPDATE
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION calculate_iwf_ytd_bests();

DROP TRIGGER IF EXISTS trg_update_iwf_meet_results_count ON public.iwf_meet_results;
CREATE TRIGGER trg_update_iwf_meet_results_count
  AFTER INSERT OR DELETE OR UPDATE
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION update_iwf_meet_results_count();

DROP TRIGGER IF EXISTS update_iwf_meet_results_updated_at ON public.iwf_meet_results;
CREATE TRIGGER update_iwf_meet_results_updated_at
  BEFORE UPDATE
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION update_iwf_updated_at_column();

DROP TRIGGER IF EXISTS iwf_meet_results_analytics_insert_trigger ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_analytics_insert_trigger
  BEFORE INSERT ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION calculate_iwf_analytics();

DROP TRIGGER IF EXISTS iwf_meet_results_analytics_update_trigger ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_analytics_update_trigger
  BEFORE UPDATE OF snatch_lift_1, snatch_lift_2, snatch_lift_3, best_snatch, cj_lift_1, cj_lift_2, cj_lift_3, best_cj, total, date
  ON public.iwf_meet_results
  FOR EACH ROW
  WHEN (
    old.snatch_lift_1 IS DISTINCT FROM new.snatch_lift_1
    OR old.snatch_lift_2 IS DISTINCT FROM new.snatch_lift_2
    OR old.snatch_lift_3 IS DISTINCT FROM new.snatch_lift_3
    OR old.best_snatch IS DISTINCT FROM new.best_snatch
    OR old.cj_lift_1 IS DISTINCT FROM new.cj_lift_1
    OR old.cj_lift_2 IS DISTINCT FROM new.cj_lift_2
    OR old.cj_lift_3 IS DISTINCT FROM new.cj_lift_3
    OR old.best_cj IS DISTINCT FROM new.best_cj
    OR old.total IS DISTINCT FROM new.total
    OR old.date IS DISTINCT FROM new.date
  )
  EXECUTE FUNCTION calculate_iwf_analytics();

DROP TRIGGER IF EXISTS iwf_meet_results_manual_override_trigger ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_manual_override_trigger
  BEFORE INSERT OR UPDATE
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION handle_iwf_manual_override();

DROP TRIGGER IF EXISTS iwf_meet_results_qpoints_auto_update ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_qpoints_auto_update
  BEFORE INSERT OR UPDATE
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION update_iwf_qpoints_on_change();

DROP TRIGGER IF EXISTS iwf_meet_results_competition_age_trigger ON public.iwf_meet_results;
CREATE TRIGGER iwf_meet_results_competition_age_trigger
  BEFORE INSERT OR UPDATE OF date, birth_year
  ON public.iwf_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION calculate_iwf_competition_age();


-- USAW meet results
CREATE TABLE IF NOT EXISTS public.usaw_meet_results (
  result_id bigserial not null,
  meet_id bigint not null,
  lifter_id bigint not null,
  meet_name text null,
  date text null,
  age_category text null,
  weight_class text null,
  lifter_name text null,
  body_weight_kg text null,
  snatch_lift_1 text null,
  snatch_lift_2 text null,
  snatch_lift_3 text null,
  best_snatch text null,
  cj_lift_1 text null,
  cj_lift_2 text null,
  cj_lift_3 text null,
  best_cj text null,
  total text null,
  created_at timestamp without time zone null default now(),
  competition_age integer null,
  qpoints numeric(10, 4) null,
  manual_override boolean null default false,
  q_masters numeric null,
  q_youth numeric null,
  wso character varying(255) null,
  club_name character varying(255) null,
  updated_at timestamp without time zone null default now(),
  gender text null,
  birth_year integer null,
  national_rank integer null,
  snatch_successful_attempts integer null,
  cj_successful_attempts integer null,
  total_successful_attempts integer null,
  best_snatch_ytd integer null,
  best_cj_ytd integer null,
  best_total_ytd integer null,
  bounce_back_snatch_2 boolean null,
  bounce_back_snatch_3 boolean null,
  bounce_back_cj_2 boolean null,
  bounce_back_cj_3 boolean null,
  CONSTRAINT meet_results_pkey PRIMARY KEY (result_id)
)
TABLESPACE pg_default;

CREATE INDEX IF NOT EXISTS idx_meet_results_date ON public.usaw_meet_results USING btree (date) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_meet_results_lifter_id ON public.usaw_meet_results USING btree (lifter_id) TABLESPACE pg_default;
CREATE INDEX IF NOT EXISTS idx_meet_results_meet_id ON public.usaw_meet_results USING btree (meet_id) TABLESPACE pg_default;

-- USAW triggers (drop if exists for idempotency)
DROP TRIGGER IF EXISTS meet_results_analytics_insert_trigger ON public.usaw_meet_results;
CREATE TRIGGER meet_results_analytics_insert_trigger
  BEFORE INSERT ON public.usaw_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION calculate_and_set_analytics();

DROP TRIGGER IF EXISTS meet_results_analytics_update_trigger ON public.usaw_meet_results;
CREATE TRIGGER meet_results_analytics_update_trigger
  BEFORE UPDATE OF snatch_lift_1, snatch_lift_2, snatch_lift_3, best_snatch, cj_lift_1, cj_lift_2, cj_lift_3, best_cj, total, lifter_id, date
  ON public.usaw_meet_results
  FOR EACH ROW
  WHEN (
    old.snatch_lift_1 IS DISTINCT FROM new.snatch_lift_1
    OR old.snatch_lift_2 IS DISTINCT FROM new.snatch_lift_2
    OR old.snatch_lift_3 IS DISTINCT FROM new.snatch_lift_3
    OR old.best_snatch IS DISTINCT FROM new.best_snatch
    OR old.cj_lift_1 IS DISTINCT FROM new.cj_lift_1
    OR old.cj_lift_2 IS DISTINCT FROM new.cj_lift_2
    OR old.cj_lift_3 IS DISTINCT FROM new.cj_lift_3
    OR old.best_cj IS DISTINCT FROM new.best_cj
    OR old.total IS DISTINCT FROM new.total
    OR old.lifter_id IS DISTINCT FROM new.lifter_id
    OR old.date IS DISTINCT FROM new.date
  )
  EXECUTE FUNCTION calculate_and_set_analytics();

DROP TRIGGER IF EXISTS meet_results_manual_override_trigger ON public.usaw_meet_results;
CREATE TRIGGER meet_results_manual_override_trigger
  BEFORE INSERT OR UPDATE
  ON public.usaw_meet_results
  FOR EACH ROW
  WHEN (new.manual_override = true)
  EXECUTE FUNCTION handle_manual_override();

DROP TRIGGER IF EXISTS qpoints_auto_update ON public.usaw_meet_results;
CREATE TRIGGER qpoints_auto_update
  BEFORE INSERT OR UPDATE
  ON public.usaw_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION update_qpoints_on_change();

DROP TRIGGER IF EXISTS update_competition_age_trigger ON public.usaw_meet_results;
CREATE TRIGGER update_competition_age_trigger
  BEFORE INSERT OR UPDATE OF date, birth_year
  ON public.usaw_meet_results
  FOR EACH ROW
  EXECUTE FUNCTION calculate_competition_age();
