/**
 * Debug CSV Format Issue
 * 
 * This script will examine the actual CSV file generated by the scraper
 * to understand why the base64 lookup is failing to find headers.
 */

const fs = require('fs');
const path = require('path');

function debugCSVFormat() {
    console.log('ðŸ” Debugging CSV Format Issue\n');

    // Look for recent CSV files in temp directory
    const tempDir = './temp';
    if (!fs.existsSync(tempDir)) {
        console.log('âŒ Temp directory not found');
        return;
    }

    const files = fs.readdirSync(tempDir)
        .filter(file => file.endsWith('.csv'))
        .map(file => ({
            name: file,
            path: path.join(tempDir, file),
            stats: fs.statSync(path.join(tempDir, file))
        }))
        .sort((a, b) => b.stats.mtime - a.stats.mtime); // Most recent first

    if (files.length === 0) {
        console.log('âŒ No CSV files found in temp directory');
        return;
    }

    console.log(`ðŸ“ Found ${files.length} CSV files, examining most recent:`);
    const mostRecent = files[0];
    console.log(`   File: ${mostRecent.name}`);
    console.log(`   Modified: ${mostRecent.stats.mtime}`);

    // Read and analyze the CSV
    const csvContent = fs.readFileSync(mostRecent.path, 'utf8');
    const lines = csvContent.split('\n').filter(line => line.trim());

    console.log(`\nðŸ“Š CSV Analysis:`);
    console.log(`   Total lines: ${lines.length}`);
    
    if (lines.length > 0) {
        console.log(`\nðŸ“‹ First few lines:`);
        for (let i = 0; i < Math.min(5, lines.length); i++) {
            console.log(`   ${i + 1}: ${lines[i]}`);
        }

        // Check if first line looks like headers
        const firstLine = lines[0];
        const firstLineCells = firstLine.split('|');
        
        console.log(`\nðŸ” Header Analysis:`);
        console.log(`   First line cells: ${firstLineCells.length}`);
        console.log(`   Cells: [${firstLineCells.map(c => `"${c.trim()}"`).join(', ')}]`);
        
        // Check for expected header names
        const expectedHeaders = ['Internal_ID', 'Name', 'Age Category', 'Weight Class'];
        const foundHeaders = expectedHeaders.map(header => {
            const index = firstLineCells.findIndex(h => h.trim() === header || h.includes(header.split(' ')[0]));
            return { header, index, found: index !== -1 };
        });

        console.log(`\nðŸ“ Header Search Results:`);
        foundHeaders.forEach(result => {
            console.log(`   ${result.header}: ${result.found ? `âœ… Found at index ${result.index}` : 'âŒ Not found'}`);
        });

        // Simulate the base64 lookup logic
        console.log(`\nðŸ§ª Simulating Base64 Lookup Logic:`);
        const headers = firstLine.split('|');
        const internalIdIndex = headers.findIndex(h => h.trim() === 'Internal_ID');
        const nameIndex = headers.findIndex(h => h.trim() === 'Name' || h.trim() === 'Lifter' || h.includes('Name'));
        const ageCategoryIndex = headers.findIndex(h => h.trim() === 'Age Category');
        const weightClassIndex = headers.findIndex(h => h.trim() === 'Weight Class');

        console.log(`   Internal_ID index: ${internalIdIndex}`);
        console.log(`   Name index: ${nameIndex}`);
        console.log(`   Age Category index: ${ageCategoryIndex}`);
        console.log(`   Weight Class index: ${weightClassIndex}`);

        if (internalIdIndex === -1 || nameIndex === -1) {
            console.log(`   âŒ Required columns not found - this is why base64 lookup is skipped!`);
        } else {
            console.log(`   âœ… Required columns found - base64 lookup should work`);
        }

        // Check for athletes missing internal_ids
        if (lines.length > 1 && internalIdIndex !== -1 && nameIndex !== -1) {
            console.log(`\nðŸ‘¥ Athletes Missing Internal_IDs:`);
            let missingCount = 0;
            for (let i = 1; i < Math.min(lines.length, 6); i++) { // Check first 5 athletes
                const cells = lines[i].split('|');
                const internalId = cells[internalIdIndex]?.trim();
                const athleteName = cells[nameIndex]?.trim();
                
                if (!internalId || internalId === 'null' || internalId === '') {
                    console.log(`   ${i}. ${athleteName} - Missing internal_id`);
                    missingCount++;
                } else {
                    console.log(`   ${i}. ${athleteName} - Has internal_id: ${internalId}`);
                }
            }
            console.log(`   Total missing internal_ids in sample: ${missingCount}`);
        }
    }
}

// Run the debug
if (require.main === module) {
    debugCSVFormat();
}

module.exports = { debugCSVFormat };